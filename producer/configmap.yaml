apiVersion: v1
kind: ConfigMap
metadata:
  name: producer-config
  namespace: his-kafka
data:
  KAFKA_BOOTSTRAP_SERVERS: "his-kafka-0.his-kafka-headless.his-kafka.svc.cluster.local:9092"
  KAFKA_TOPIC: "hospital"
  producer.py: |
    from kafka import KafkaProducer
    import json
    import time
    import random
    import os

    bootstrap_servers = os.environ.get('KAFKA_BOOTSTRAP_SERVERS', 'localhost:9092')
    topic = os.environ.get('KAFKA_TOPIC', 'hospital')

    print(f"Connecting to Kafka at {bootstrap_servers}...")
    producer = KafkaProducer(
        bootstrap_servers=bootstrap_servers,
        value_serializer=lambda v: json.dumps(v).encode('utf-8')
    )
    print("Connected!")

    departments = ['Cardiology', 'Neurology', 'Pediatrics', 'Oncology', 'Emergency']
    designations = ['Doctor', 'Nurse', 'Technician', 'Admin']

    while True:
        # Simulate a hospital event
        dept = random.choice(departments)
        msg = {
            'event': 'status_update',
            'department': dept,
            'designation': random.choice(designations),
            'status': 'active',
            'timestamp': time.time()
        }
        
        # Send to hospital topic
        print(f"Sending to {topic}: {msg}")
        producer.send(topic, value=msg)
        
        # Also send to department topic if it's a department update
        producer.send('department', value={'dept': dept, 'action': 'update'})
        
        producer.flush()
        time.sleep(5)
